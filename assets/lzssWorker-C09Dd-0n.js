function d(t,s){if(s.data.length!==t.byteLength*2)throw new Error("Data length does not match image data length");for(let e=0;e<t.byteLength;e+=2){const n=t.getUint16(e),o=((n&31744)>>10)*8,f=((n&992)>>5)*8,i=(n&31)*8;s.data[e*2]=o,s.data[e*2+1]=f,s.data[e*2+2]=i,s.data[e*2+3]=n&32768?0:255}}function p(t){const s=new DataView(new ArrayBuffer(t.length/2));for(let e=0;e<t.length;e+=4){const n=t[e],o=t[e+1],f=t[e+2],i=t[e+3];s.setUint16(e/2,n/8<<10|o/8<<5|f/8|(i?0:32768))}return s}const u=4096,w=2,B=18;function A(t,s){const e=new DataView(new ArrayBuffer(s));let n=t.byteLength,o=0,f=0,i=u-B;const r=new DataView(new ArrayBuffer(u+B-1));for(let l=0;l<u-B;l++)r.setInt8(l,32);let c=0;for(;;){if(c=Math.floor(c/2),c<256){if(--n<0)break;c=t.getUint8(f++)|65280}if(c&1){if(--n<0)break;const l=t.getUint8(f++);e.setUint8(o++,l),r.setUint8(i++,l),i&=u-1}else{if(--n<0)break;let l=t.getUint8(f++);if(--n<0)break;let a=t.getUint8(f++);l|=(a&240)<<4,a=(a&15)+w+1;for(let y=0;y<a;y++){const g=r.getUint8(l+y&u-1);e.setUint8(o++,g),r.setUint8(i++,g),i&=u-1}}}return e}function L(t){const s=new DataView(new ArrayBuffer(t.byteLength*2)),e=new DataView(new ArrayBuffer(u+B-1));for(let a=0;a<u-B;a++)e.setUint8(a,32);let n=0,o=0,f=u-B,i=0,r=0,c=0;for(c=o++;n<t.byteLength;){r===8&&(s.setUint8(c,i),c=o++,i=0,r=0);let a=0,y=0;for(let g=0;g<u-B;g++){let h=0;for(;h<B&&n+h<t.byteLength&&e.getUint8(g+h&u-1)===t.getUint8(n+h)&&(h++,!(h>=B)););h>a&&(a=h,y=g)}if(a>w&&S(f,y,a)){const g=a-w-1,h=y>>8&15;s.setUint8(o++,y&255),s.setUint8(o++,h<<4|g);for(let U=0;U<a;U++){const b=t.getUint8(n+U);e.setUint8(f,b),f++,f>=u&&(f=0)}n+=a,r++}else{const g=t.getUint8(n++);s.setUint8(o++,g),i|=1<<r,r++,e.setUint8(f,g),f++,f>=u&&(f=0)}}r>0&&s.setUint8(c,i);const l=s.buffer.slice(0,o);return new DataView(l)}function S(t,s,e){for(let n=0;n<e;n++)if((s+n)%u===t)return!1;return!0}onmessage=async t=>{if(t.data.type==="compress"){const s=p(t.data.uIntArray),e=L(s);postMessage({id:t.data.id,type:"compressRes",dataBuffer:e.buffer})}if(t.data.type==="decompress"){const{compressedDataView:s,outputSize:e,width:n,height:o}=t.data,f=A(s,e),i=new OffscreenCanvas(n,o);i.width=n,i.height=o;const r=i.getContext("2d"),c=r==null?void 0:r.getImageData(0,0,i.width,i.height);if(!c||(d(f,c),!r))return;postMessage({id:t.data.id,type:"decompressRes",imageData:c})}};
