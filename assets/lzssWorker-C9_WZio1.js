function b(t,i){if(i.data.length!==t.byteLength*2)throw new Error("Data length does not match image data length");for(let e=0;e<t.byteLength;e+=2){const n=t.getUint16(e),l=((n&31744)>>10)*8,o=((n&992)>>5)*8,s=(n&31)*8;i.data[e*2]=l,i.data[e*2+1]=o,i.data[e*2+2]=s,i.data[e*2+3]=n&32768?0:255}}const g=4096,y=2,d=18;function p(t,i){const e=new DataView(new ArrayBuffer(i));let n=t.byteLength,l=0,o=0,s=g-d;const a=new DataView(new ArrayBuffer(g+d-1));for(let f=0;f<g-d;f++)a.setInt8(f,32);let c=0;for(;;){if(c=Math.floor(c/2),c<256){if(--n<0)break;c=t.getUint8(o++)|65280}if(c&1){if(--n<0)break;const f=t.getUint8(o++);e.setUint8(l++,f),a.setUint8(s++,f),s&=g-1}else{if(--n<0)break;let f=t.getUint8(o++);if(--n<0)break;let r=t.getUint8(o++);f|=(r&240)<<4,r=(r&15)+y;for(let U=0;U<=r;U++){const w=a.getUint8(f+U&g-1);e.setUint8(l++,w),a.setUint8(s++,w),s&=g-1}}}return e}function L(t){const i=t.byteLength,e=new DataView(new ArrayBuffer(g+d-1)),n=new DataView(new ArrayBuffer(i*2));let l=g-d,o=0,s=0,a=0,c=0,f=0;for(let r=0;r<g-d;r++)e.setUint8(r,32);for(c=s++,a=0;o<i;){f===8&&(n.setUint8(c,a),c=s++,a=0,f=0);let r=0,U=0;const w=Math.min(d,i-o);if(o+y<i)for(let u=0;u<g;u++){let h=0;for(;h<w&&t.getUint8(o+h)===e.getUint8(u+h&g-1);)h++;if(h>r&&(r=h,U=u,r>=d))break}if(r<=y){const u=t.getUint8(o++);n.setUint8(s++,u),a|=1<<f,e.setUint8(l++,u),l&=g-1}else{const u=r-y-1;n.setUint8(s++,U&255),n.setUint8(s++,U>>4&240|u&15);for(let h=0;h<r;h++){const B=t.getUint8(o+h);e.setUint8(l++,B),l&=g-1}o+=r}f++}return f>0&&n.setUint8(c,a),new DataView(n.buffer.slice(0,s))}onmessage=async t=>{if(t.data.type==="compress"){const{decompressedDataView:i}=t.data,e=L(i);postMessage({id:t.data.id,type:"compressRes",dataView:e})}if(t.data.type==="decompress"){const{compressedDataView:i,outputSize:e,width:n,height:l}=t.data,o=p(i,e),s=new OffscreenCanvas(n,l);s.width=n,s.height=l;const a=s.getContext("2d"),c=a==null?void 0:a.getImageData(0,0,s.width,s.height);if(!c||(b(o,c),!a))return;postMessage({id:t.data.id,type:"decompressRes",imageData:c})}};
